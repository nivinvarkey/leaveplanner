<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic Piping | Admin Leave Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0b0f1a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .gantt-container { display: grid; grid-template-columns: 350px 1fr; }
        .week-segment { flex: 1; border-right: 1px solid #1e293b; font-size: 8px; text-align: center; padding-top: 4px; color: #475569; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .hidden { display: none !important; }
        .leave-bar:hover .tooltip { display: block; }
    </style>
</head>
<body class="p-4 md:p-6">

    <div id="authSection" class="max-w-md mx-auto mt-20 bg-slate-900 p-8 rounded-2xl border border-slate-800 shadow-2xl">
        <h2 class="text-2xl font-bold text-emerald-400 mb-6 text-center">EPIC PIPING LOGIN</h2>
        <div class="space-y-4">
            <div>
                <label class="text-xs text-slate-500 uppercase font-bold mb-1 block">Username</label>
                <input type="text" id="authUser" placeholder="Enter Username" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-lg outline-none focus:border-emerald-500">
            </div>
            <div>
                <label class="text-xs text-slate-500 uppercase font-bold mb-1 block">Password</label>
                <input type="password" id="authPass" placeholder="••••••••" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-lg outline-none focus:border-emerald-500">
            </div>
            <button onclick="handleLogin()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition-all">Enter System</button>
            <p class="text-[10px] text-center text-slate-600 italic">Default Admin: admin / admin123</p>
        </div>
    </div>

    <div id="dashboardSection" class="hidden max-w-[1700px] mx-auto">
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-emerald-400 tracking-tight">ANNUAL LEAVE PLANNER - 2026</h1>
                <p id="userWelcome" class="text-slate-500 text-sm"></p>
            </div>
            <button onclick="logout()" class="bg-slate-800 hover:bg-red-900/40 text-slate-300 px-4 py-2 rounded-lg text-xs border border-slate-700">Logout</button>
        </header>

        <div id="adminPanel" class="hidden mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-slate-900 border border-emerald-500/20 p-5 rounded-xl">
                <h3 class="text-emerald-400 font-bold text-xs uppercase mb-4">Department & Manager Setup</h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="deptInput" placeholder="New Dept Name" class="flex-1 bg-slate-800 border border-slate-700 p-2 rounded text-sm outline-none">
                    <button onclick="addDept()" class="bg-emerald-600 px-4 py-2 rounded text-xs font-bold">Add Dept</button>
                </div>
                <div id="deptList" class="space-y-2 max-h-40 overflow-y-auto"></div>
            </div>

            <div class="bg-slate-900 border border-emerald-500/20 p-5 rounded-xl">
                <h3 class="text-emerald-400 font-bold text-xs uppercase mb-4">Create Employee/Manager</h3>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="text" id="regUser" placeholder="Username" class="bg-slate-800 border border-slate-700 p-2 rounded text-sm outline-none">
                    <input type="text" id="regName" placeholder="Full Name" class="bg-slate-800 border border-slate-700 p-2 rounded text-sm outline-none">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <select id="regRole" class="bg-slate-800 border border-slate-700 p-2 rounded text-sm outline-none">
                        <option value="employee">Employee</option>
                        <option value="manager">Manager</option>
                    </select>
                    <select id="regDept" class="bg-slate-800 border border-slate-700 p-2 rounded text-sm outline-none"></select>
                </div>
                <button onclick="createUser()" class="w-full bg-blue-600 py-2 rounded text-xs font-bold">Register User</button>
            </div>
        </div>

        <div id="applyPanel" class="hidden mb-6 bg-slate-900/50 p-6 rounded-xl border border-slate-800">
            <h3 class="text-xs font-bold uppercase text-emerald-400 mb-4">Submit Leave Plan</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" id="leaveUser" class="bg-slate-800 border border-slate-700 p-2.5 rounded text-sm outline-none" readonly>
                <input type="date" id="leaveStart" class="bg-slate-800 border border-slate-700 p-2.5 rounded text-sm">
                <input type="date" id="leaveEnd" class="bg-slate-800 border border-slate-700 p-2.5 rounded text-sm">
                <button onclick="submitLeave()" class="bg-emerald-600 font-bold rounded py-2 transition-all">Apply Dates</button>
            </div>
        </div>

        <div id="conflictPanel" class="hidden mb-6 bg-red-950/20 border border-red-900/40 rounded-xl p-4">
            <h2 class="text-red-500 font-bold text-xs mb-2 uppercase">⚠️ Overlap Alerts</h2>
            <div id="conflictList" class="text-xs text-red-300 grid grid-cols-1 md:grid-cols-2 gap-2"></div>
        </div>

        <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-2xl">
            <div class="gantt-container bg-slate-800/40 border-b border-slate-700">
                <div class="p-4 font-bold text-slate-500 uppercase text-[10px] tracking-widest flex items-end border-r border-slate-700">Department Resources</div>
                <div class="flex flex-col">
                    <div class="flex border-b border-slate-700/50">
                        <script>
                            ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].forEach(m => 
                                document.write(`<div class="flex-1 text-center py-3 text-[10px] font-bold uppercase border-r border-slate-700/50 text-slate-400">${m}</div>`));
                        </script>
                    </div>
                </div>
            </div>
            <div id="chartBody" class="max-h-[50vh] overflow-y-auto"></div>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        let db = JSON.parse(localStorage.getItem('epic_db')) || {
            users: [{ user: "admin", pass: "admin123", name: "System Admin", role: "admin", dept: "Global" }],
            depts: ["Team B", "Team C", "Support Team", "DC Team"],
            leaves: []
        };

        let currentSession = null;

        // --- AUTH ---
        function handleLogin() {
            const u = document.getElementById('authUser').value;
            const p = document.getElementById('authPass').value;
            const account = db.users.find(x => x.user === u && x.pass === p);
            
            if(account) {
                currentSession = account;
                initDashboard();
            } else { alert("Wrong username/password"); }
        }

        function logout() {
            currentSession = null;
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
        }

        // --- DASHBOARD INIT ---
        function initDashboard() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('userWelcome').innerText = `${currentSession.name} (${currentSession.role.toUpperCase()}) | ${currentSession.dept}`;
            
            // Toggle visibility
            document.getElementById('adminPanel').classList.toggle('hidden', currentSession.role !== 'admin');
            document.getElementById('applyPanel').classList.toggle('hidden', currentSession.role === 'admin');
            
            if(currentSession.role !== 'admin') {
                document.getElementById('leaveUser').value = currentSession.name;
            }

            renderAdminTools();
            renderChart();
        }

        // --- ADMIN ACTIONS ---
        function addDept() {
            const name = document.getElementById('deptInput').value;
            if(name) { db.depts.push(name); save(); renderAdminTools(); }
        }

        function createUser() {
            const user = document.getElementById('regUser').value;
            const name = document.getElementById('regName').value;
            const role = document.getElementById('regRole').value;
            const dept = document.getElementById('regDept').value;
            
            if(user && name) {
                db.users.push({ user, pass: "123", name, role, dept }); // Default pass 123
                save();
                alert(`User Created! Password is: 123`);
            }
        }

        function renderAdminTools() {
            const dList = document.getElementById('deptList');
            const dSelect = document.getElementById('regDept');
            dList.innerHTML = ''; dSelect.innerHTML = '';
            
            db.depts.forEach(d => {
                dList.innerHTML += `<div class="flex justify-between items-center bg-slate-800 p-2 rounded text-xs border border-slate-700">
                    <span>${d}</span>
                    <button onclick="removeDept('${d}')" class="text-red-500">✕</button>
                </div>`;
                dSelect.innerHTML += `<option>${d}</option>`;
            });
        }

        function removeDept(name) {
            db.depts = db.depts.filter(d => d !== name);
            save(); renderAdminTools();
        }

        // --- LEAVE ACTIONS ---
        function submitLeave() {
            const start = document.getElementById('leaveStart').value;
            const end = document.getElementById('leaveEnd').value;
            if(!start || !end) return;

            db.leaves.push({
                id: Date.now(),
                name: currentSession.name,
                dept: currentSession.dept,
                start, end,
                status: 'pending',
                history: null
            });
            save(); renderChart();
        }

        function editLeave(id) {
            const idx = db.leaves.findIndex(l => l.id === id);
            const nS = prompt("New Start Date:", db.leaves[idx].start);
            const nE = prompt("New End Date:", db.leaves[idx].end);
            if(nS && nE) {
                db.leaves[idx].history = { oldS: db.leaves[idx].start, oldE: db.leaves[idx].end };
                db.leaves[idx].start = nS;
                db.leaves[idx].end = nE;
                save(); renderChart();
            }
        }

        function approveLeave(id) {
            const idx = db.leaves.findIndex(l => l.id === id);
            db.leaves[idx].status = 'approved';
            save(); renderChart();
        }

        function deleteLeave(id) {
            if(confirm("Delete this entry?")) {
                db.leaves = db.leaves.filter(l => l.id !== id);
                save(); renderChart();
            }
        }

        function save() {
            localStorage.setItem('epic_db', JSON.stringify(db));
        }

        // --- CHART & CONFLICTS ---
        function renderChart() {
            const body = document.getElementById('chartBody');
            const cList = document.getElementById('conflictList');
            const cPanel = document.getElementById('conflictPanel');
            body.innerHTML = ''; cList.innerHTML = '';
            let conflicts = [];

            // Filter logic
            const visible = db.leaves.filter(l => {
                if(currentSession.role === 'admin') return true;
                if(currentSession.role === 'manager') return l.dept === currentSession.dept;
                return l.dept === currentSession.dept; // Employees see team schedule
            });

            visible.forEach(emp => {
                const overlaps = db.leaves.filter(o => 
                    o.id !== emp.id && o.dept === emp.dept && 
                    new Date(emp.start) <= new Date(o.end) && new Date(o.start) <= new Date(emp.end)
                );

                if(emp.name === currentSession.name && overlaps.length > 0) {
                    overlaps.forEach(o => conflicts.push(`Conflict with <b>${o.name}</b> (${o.start} to ${o.end})`));
                }

                const start = new Date(emp.start);
                const end = new Date(emp.end);
                const left = ((start - new Date('2026-01-01')) / (1000*60*60*24) / 365) * 100;
                const width = ((end - start) / (1000*60*60*24) / 365) * 100;

                let row = document.createElement('div');
                row.className = 'gantt-container border-b border-slate-800/40 items-center';
                
                let btns = '';
                if(currentSession.role === 'admin' || (currentSession.role === 'manager' && emp.dept === currentSession.dept)) {
                    btns += `<button onclick="approveLeave(${emp.id})" class="text-[9px] px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">${emp.status === 'approved' ? '✓' : 'Approve'}</button>`;
                    btns += `<button onclick="deleteLeave(${emp.id})" class="ml-1 text-[9px] px-2 py-1 rounded bg-red-500/20 text-red-400 border border-red-500/30">✕</button>`;
                }
                if(emp.name === currentSession.name || currentSession.role === 'admin') {
                    btns += `<button onclick="editLeave(${emp.id})" class="ml-1 text-[9px] px-2 py-1 rounded bg-blue-500/20 text-blue-400 border border-blue-500/30">Edit</button>`;
                }

                row.innerHTML = `
                    <div class="p-3 border-r border-slate-800 flex justify-between items-center overflow-hidden">
                        <div class="truncate">
                            <div class="text-[11px] font-bold ${overlaps.length > 0 ? 'text-red-400' : 'text-slate-200'}">${emp.name}</div>
                            <div class="text-[8px] text-slate-500 uppercase font-bold">${emp.dept} | ${emp.status}</div>
                            ${emp.history ? `<div class="text-[7px] text-orange-400 mt-1 italic">Was: ${emp.history.oldS} to ${emp.history.oldE}</div>` : ''}
                        </div>
                        <div class="flex">${btns}</div>
                    </div>
                    <div class="relative h-14 w-full flex items-center px-1">
                        <div class="leave-bar absolute h-7 rounded shadow-xl flex items-center px-3 transition-all hover:scale-[1.01]"
                             style="left: ${left}%; width: ${width}%; background: ${emp.status === 'approved' ? 'linear-gradient(90deg, #064e3b, #10b981)' : 'linear-gradient(90deg, #1e293b, #334155)'}; border: 1px solid ${overlaps.length > 0 ? '#ef4444' : 'transparent'}">
                            <span class="text-[8px] font-black text-white truncate uppercase">${overlaps.length > 0 ? '⚠️ CONFLICT' : emp.status}</span>
                            <div class="tooltip hidden absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-white text-slate-900 text-[10px] p-2 rounded shadow-2xl z-50 whitespace-nowrap font-bold">
                                ${emp.start} to ${emp.end}
                            </div>
                        </div>
                    </div>
                `;
                body.appendChild(row);
            });

            cPanel.classList.toggle('hidden', conflicts.length === 0);
            cList.innerHTML = conflicts.map(c => `<div>${c}</div>`).join('');
        }
    </script>
</body>
</html>
