<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Epic Piping | Enterprise Leave System</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background-color: #0b0f1a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
  .gantt-container { display: grid; grid-template-columns: 400px 1fr; }
  .hidden { display: none !important; }
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
</style>
</head>
<body class="p-4">

<!-- AUTH SECTION -->
<div id="authSection" class="max-w-md mx-auto mt-10">

  <!-- LOGIN -->
  <div id="loginBox" class="bg-slate-900 p-8 rounded-2xl border border-slate-800 shadow-2xl">
    <h2 class="text-2xl font-bold text-emerald-400 mb-6 text-center uppercase tracking-widest">Epic Piping Login</h2>
    <div class="space-y-4">
      <input type="text" id="authUser" placeholder="Username" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-lg outline-none focus:border-emerald-500">
      <input type="password" id="authPass" placeholder="Password" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-lg outline-none focus:border-emerald-500">
      <button onclick="handleLogin()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg uppercase tracking-widest">Sign In</button>
      <div class="flex justify-between items-center text-[11px] mt-4 px-1">
        <button onclick="showView('signupBox')" class="text-emerald-500 hover:underline">Create New Profile</button>
        <button onclick="showView('forgotBox')" class="text-slate-500 hover:text-white">Forgot Password?</button>
      </div>
    </div>
  </div>

  <!-- SIGNUP -->
  <div id="signupBox" class="hidden bg-slate-900 p-8 rounded-2xl border border-emerald-500/30 shadow-2xl">
    <h2 class="text-xl font-bold text-emerald-400 mb-4 text-center uppercase">New Registration</h2>
    <div class="space-y-3">
      <input type="text" id="signU" placeholder="Choose Username" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm">
      <input type="password" id="signP" placeholder="Create Password" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm">
      <input type="text" id="signN" placeholder="Full Name" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm">
      <select id="signRole" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm">
        <option value="employee">Employee</option>
        <option value="manager">Manager</option>
      </select>
      <div class="grid grid-cols-2 gap-2">
        <select id="signD" class="bg-slate-800 border border-slate-700 p-2 rounded text-xs"></select>
        <select id="signT" class="bg-slate-800 border border-slate-700 p-2 rounded text-xs"></select>
      </div>
      <button onclick="handleSignup()" class="w-full bg-emerald-600 py-3 rounded-lg font-bold uppercase text-xs">Register</button>
      <button onclick="showView('loginBox')" class="w-full text-[10px] text-slate-500 uppercase mt-2">Back to Login</button>
    </div>
  </div>

  <!-- FORGOT -->
  <div id="forgotBox" class="hidden bg-slate-900 p-8 rounded-2xl border border-blue-500/30 shadow-2xl">
    <h2 class="text-xl font-bold text-blue-400 mb-4 text-center uppercase tracking-widest">Password Recovery</h2>
    <p class="text-[10px] text-slate-400 mb-4 text-center px-4">Admin can reset passwords from dashboard.</p>
    <button onclick="showView('loginBox')" class="w-full text-[10px] text-slate-500 uppercase">Return to Login</button>
  </div>

</div>

<!-- DASHBOARD -->
<div id="dashboardSection" class="hidden max-w-[1800px] mx-auto">

  <!-- HEADER -->
  <header class="flex justify-between items-center mb-6 bg-slate-900 p-4 rounded-xl border border-slate-800">
    <div>
      <h1 class="text-xl font-bold text-emerald-400">EPIC PIPING PLANNER 2026</h1>
      <p id="userWelcome" class="text-slate-500 text-xs font-bold uppercase tracking-wider"></p>
    </div>
    <div class="flex gap-3">
      <button onclick="toggleProfile()" class="bg-blue-600/20 text-blue-400 px-4 py-2 rounded text-xs border border-blue-500/30">My Security</button>
      <button onclick="logout()" class="bg-slate-800 text-slate-400 px-4 py-2 rounded text-xs border border-slate-700">Logout</button>
    </div>
  </header>

  <!-- PROFILE PANEL -->
  <div id="profilePanel" class="hidden mb-6 bg-slate-900 p-6 rounded-xl border border-blue-500/30 max-w-sm mx-auto shadow-2xl">
    <h3 class="text-blue-400 font-bold text-xs uppercase mb-4">Change My Password</h3>
    <input type="password" id="editPass" placeholder="New Password" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm mb-4 outline-none">
    <button onclick="saveProfile()" class="w-full bg-blue-600 py-2 rounded font-bold text-xs">UPDATE PASSWORD</button>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="hidden space-y-6 mb-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- ORG SETUP -->
      <div class="bg-slate-900 border border-slate-800 p-5 rounded-xl">
        <h3 class="text-emerald-400 text-xs font-bold uppercase mb-4">Organization Setup</h3>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <input type="text" id="newDept" placeholder="Department" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-xs mb-2">
            <button onclick="addDept()" class="w-full bg-emerald-600 py-1 rounded text-[10px] font-bold">ADD DEPT</button>
          </div>
          <div>
            <select id="parentDept" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-xs mb-2"></select>
            <input type="text" id="newTeam" placeholder="Team Name" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-xs mb-2">
            <button onclick="addTeam()" class="w-full bg-blue-600 py-1 rounded text-[10px] font-bold">ADD TEAM</button>
          </div>
        </div>
      </div>

      <!-- USERS -->
      <div class="bg-slate-900 border border-slate-800 p-5 rounded-xl shadow-lg h-48 overflow-y-auto">
        <h3 class="text-slate-400 text-xs font-bold uppercase mb-4">System Users</h3>
        <table class="w-full text-[10px] text-slate-400">
          <tbody id="userListTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ACTION PANEL (LEAVE REQUEST) -->
  <div id="actionPanel" class="mb-6 bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-xl">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
      <div id="staffSelectContainer" class="hidden">
        <label class="text-[10px] text-slate-500 font-bold block mb-1 uppercase text-xs">Employee Name</label>
        <select id="leaveStaffName" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm"></select>
      </div>
      <div id="selfNameContainer">
        <label class="text-[10px] text-slate-500 font-bold block mb-1 uppercase text-xs">Name</label>
        <input type="text" id="leaveSelfName" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm" readonly>
      </div>
      <div><input type="date" id="leaveStart" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm"></div>
      <div><input type="date" id="leaveEnd" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm"></div>
      <button onclick="submitLeave()" class="bg-emerald-600 font-bold rounded py-2 text-sm hover:bg-emerald-500">SUBMIT DATES</button>
    </div>
  </div>

  <!-- LEAVE CHART -->
  <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-2xl">
    <div id="chartBody" class="max-h-[60vh] overflow-y-auto"></div>
  </div>

  <!-- DECLINED LEAVE SECTION -->
  <div id="declinedSection" class="hidden mt-6 bg-slate-900 border border-red-600 p-4 rounded-xl">
    <h3 class="text-red-400 text-xs font-bold uppercase mb-2">Declined Leaves (View Only)</h3>
    <div id="declinedLeavesList" class="text-[10px] text-slate-400"></div>
  </div>

</div>

<script>
// DATABASE
let db = JSON.parse(localStorage.getItem('epic_piping_db_v8')) || {
  depts: [], teams: [], leaves: [], declined: [],
  users: [{ user: "admin", pass: "admin123", name: "System Admin", role: "admin", email: "" }]
};
let session = null;

// NAVIGATION
function showView(id){
  ['loginBox','signupBox','forgotBox'].forEach(box=>document.getElementById(box).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id==='signupBox') populateSignupSelects();
}

// LOGIN
function handleLogin(){
  const u=document.getElementById('authUser').value.trim();
  const p=document.getElementById('authPass').value.trim();
  const acc=db.users.find(x=>x.user===u && x.pass===p);
  if(acc){ session=acc; initDashboard(); } else { alert("Login failed."); }
}

// SIGNUP
function handleSignup(){
  const u=document.getElementById('signU').value.trim();
  const p=document.getElementById('signP').value.trim();
  const n=document.getElementById('signN').value.trim();
  const r=document.getElementById('signRole').value;
  const d=document.getElementById('signD').value;
  const t=document.getElementById('signT').value;
  if(!u||!p||!n) return alert("Fill all fields");
  if(db.users.some(x=>x.user===u)) return alert("Username taken");
  db.users.push({ user:u, pass:p, name:n, role:r, dept:d, team:r==='employee'?t:null });
  save(); alert("Signup success"); showView('loginBox');
}

// DASHBOARD INIT
function initDashboard(){
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('dashboardSection').classList.remove('hidden');
  document.getElementById('userWelcome').innerText=`${session.name} | ${session.role} | ${session.dept || ''}`;
  document.getElementById('adminPanel').classList.toggle('hidden', session.role!=='admin');
  if(session.role==='manager'){
    document.getElementById('staffSelectContainer').classList.remove('hidden');
    document.getElementById('selfNameContainer').classList.add('hidden');
    populateManagerStaffList();
  } else {
    document.getElementById('leaveSelfName').value=session.name;
  }
  refreshAdminUI(); renderChart(); renderDeclined();
}

// ... (remaining functions: toggleProfile, saveProfile, logout, save, addDept, addTeam, refreshAdminUI, adminResetPass, populateSignupSelects, filterSignupTeams, populateManagerStaffList, submitLeave, modStatus, renderChart, renderDeclined)
</script>

</body>
</html>
